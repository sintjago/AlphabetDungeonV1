<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donjon de l'Alphabet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(10, 40px);
      grid-template-rows: repeat(10, 40px);
      margin: 20px auto;
      border: 2px solid #333;
      width: 400px;
      height: 400px;
    }
    .cell {
      width: 40px;
      height: 40px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }
    .player { background-color: #4CAF50; color: white; }
    .monster { background-color: #f44336; color: white; }
    .treasure { background-color: #ffeb3b; color: #333; }
    .potion { background-color: #2196F3; color: white; }
    .stairs { background-color: #9C27B0; color: white; }
    .wall { background-color: #999; }
    #event-log {
      max-width: 400px;
      margin: 20px auto;
      text-align: left;
      border: 1px solid #ddd;
      padding: 10px;
      height: 100px;
      overflow-y: auto;
      background: #fefefe;
    }
    .log-entry {
      cursor: pointer;
      color: #4CAF50;
      margin: 0;
    }
    .log-entry:hover {
      text-decoration: underline;
    }
    .accordion {
      max-width: 600px;
      margin: 10px auto;
      text-align: left;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
    .accordion h3 {
      margin: 0;
      padding: 10px;
      background: #eee;
      cursor: pointer;
    }
    .accordion-content {
      display: none;
      padding: 10px;
    }
    .sound-toggle {
      cursor: pointer;
      margin-left: 10px;
    }
    #letters-conquered {
      max-width: 400px;
      margin: 20px auto;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fafafa;
    }
    .conquered-letter {
      display: inline-block;
      margin: 4px;
      padding: 6px 10px;
      border: 1px solid #999;
      border-radius: 4px;
      cursor: pointer;
      background-color: #e0ffe0;
    }
    .conquered-letter:hover {
      background-color: #c0ffc0;
    }
  </style>
</head>
<body>
  <h1>Donjon de l'Alphabet</h1>

  <div class="accordion">
    <h3 onclick="toggleAccordion()">Comment jouer</h3>
    <div class="accordion-content" id="instructions">
      <ul>
        <li><strong>J</strong> = Joueur</li>
        <li><strong>T</strong> = Tr√©sor</li>
        <li><strong>P</strong> = Potion</li>
        <li><strong>E</strong> = Escaliers vers le niveau suivant</li>
        <li><strong>A‚ÄìZ</strong> = Monstres. Cliquez dessus pour entendre leur description !</li>
      </ul>
      <p>Utilisez les fl√®ches du clavier pour vous d√©placer. Combattez les monstres avec des d√©s. Collectez de l‚Äôor, des potions, et survivez √† chaque niveau !</p>
    </div>
  </div>

  <div id="game"></div>

  <p id="status">Utilisez les touches fl√©ch√©es pour explorer !</p>
  <p>
    Niveau : <span id="level">A</span> |
    Sant√© : <span id="health">100</span> |
    Armure : <span id="armor">0</span> |
    Pi√®ces : <span id="coins">0</span>
    <span class="sound-toggle" onclick="toggleSound()">üîä</span>
  </p>

  <div id="dice-game" style="display:none;">
    <p>
      Lancez les d√©s ! Cliquez sur chaque bouton pour lancer.
      <button onclick="autoResolveCombat()">R√©solution automatique</button>
    </p>
    <p>
      Sant√© du joueur : <span id="player-combat-health">0</span> |
      Monstre <span id="monster-type">X</span> Sant√© : <span id="monster-combat-health">0</span>
    </p>
    <button onclick="rollPlayerDice()">D√© du joueur : <span id="player-dice">0</span></button>
    <button onclick="rollMonsterDice()">D√© du monstre : <span id="monster-dice">0</span></button>
    <p id="dice-result"></p>
  </div>

  <div id="event-log">
    <p><strong>Journal des √©v√©nements :</strong></p>
    <div id="log-entries"></div>
  </div>

  <div id="letters-conquered">
    <strong>Lettres conquises :</strong>
    <div id="conquered-list"></div>
  </div>
<script>
  const frenchAlphabet = [
    "A", "B", "C", "D", "E", "F", "G", "H", "I",
    "J", "K", "L", "M", "N", "O", "P", "Q", "R",
    "S", "T", "U", "V", "W", "X", "Y", "Z"
  ];

  const gameSize = 10;
  const gameGrid = document.getElementById("game");

  let player = { x: 0, y: 0, sante: 100, armure: 0, pieces: 0, santeBase: 100 };
  let niveauActuel = 0;
  let monstres = [], tresors = [], potions = [], murs = [], escaliers = {};
  let monstreActuel = null;
  let joueurLance = false, monstreLance = false, autoResoudre = false;
  let lettresConquises = {};

  let sonActive = true;

  const etiquettes = {
    J: "J comme Joueur",
    T: "T comme Tr√©sor",
    P: "P comme Potion",
    E: "E comme Escaliers"
  };

  const motsParLettre = {
    A: "A comme Avion", B: "B comme Bateau", C: "C comme Chat", D: "D comme Dragon",
    E: "E comme √âtoile", F: "F comme Fleur", G: "G comme G√¢teau", H: "H comme H√©risson",
    I: "I comme √éle", J: "J comme Joueur", K: "K comme Koala", L: "L comme Lion",
    M: "M comme Maison", N: "N comme Nuage", O: "O comme Orange", P: "P comme Potion",
    Q: "Q comme Quatre", R: "R comme Renard", S: "S comme Soleil", T: "T comme Tr√©sor",
    U: "U comme Uniforme", V: "V comme Voiture", W: "W comme Wagon", X: "X comme Xylophone",
    Y: "Y comme Yaourt", Z: "Z comme Z√®bre"
  };

  const toggleAccordion = () => {
    const panel = document.getElementById("instructions");
    panel.style.display = panel.style.display === "block" ? "none" : "block";
  };

  const toggleSound = () => {
    sonActive = !sonActive;
    document.querySelector('.sound-toggle').textContent = sonActive ? 'üîä' : 'üîá';
  };

  const speak = (texte) => {
    if (!sonActive) return;
    const utter = new SpeechSynthesisUtterance(texte);
    utter.lang = "fr-FR";
    speechSynthesis.cancel();
    setTimeout(() => speechSynthesis.speak(utter), 100);
  };

  const speakAndWait = (texte, callback) => {
    if (!sonActive) return callback();
    const utter = new SpeechSynthesisUtterance(texte);
    utter.lang = "fr-FR";
    utter.onend = callback;
    speechSynthesis.cancel();
    setTimeout(() => speechSynthesis.speak(utter), 100);
  };

  const logEvent = (message) => {
    const entry = document.createElement("p");
    entry.textContent = message;
    entry.className = "log-entry";
    const parts = message.split(" ");
    const letter = parts[parts.length - 1];
    if (letter.length === 1 && frenchAlphabet.includes(letter)) {
      entry.onclick = () => speak(motsParLettre[letter] || letter);
    }
    const logContainer = document.getElementById("log-entries");
    if (logContainer) logContainer.appendChild(entry);
  };

  const updateConqueredLetters = () => {
    const container = document.getElementById("conquered-list");
    container.innerHTML = '';
    Object.entries(lettresConquises).forEach(([lettre, nombre]) => {
      const box = document.createElement("span");
      box.className = "conquered-letter";
      box.textContent = `${lettre} √ó ${nombre}`;
      box.onclick = () => speak(motsParLettre[lettre] || lettre);
      container.appendChild(box);
    });
  };

  const lancerDe = () => Math.floor(Math.random() * 20) + 1;

  const rollPlayerDice = () => {
    if (joueurLance) return;
    const resultat = lancerDe();
    document.getElementById('player-dice').textContent = resultat;
    speak(`Joueur lance ${resultat}`);
    joueurLance = true;
    evaluerCombat();
  };

  const rollMonsterDice = () => {
    if (monstreLance) return;
    const resultat = lancerDe();
    document.getElementById('monster-dice').textContent = resultat;
    speak(`Monstre lance ${resultat}`);
    monstreLance = true;
    evaluerCombat();
  };

  const autoResolveCombat = () => {
    if (!monstreActuel) return;
    autoResoudre = true;

    const loop = () => {
      if (!monstreActuel || !autoResoudre) return;
      const jetJoueur = lancerDe();
      const jetMonstre = lancerDe();
      document.getElementById('player-dice').textContent = jetJoueur;
      document.getElementById('monster-dice').textContent = jetMonstre;
      joueurLance = monstreLance = true;

      speakAndWait(`Joueur lance ${jetJoueur}`, () => {
        speakAndWait(`Monstre lance ${jetMonstre}`, () => {
          evaluerCombat();
          if (monstreActuel && autoResoudre) setTimeout(loop, 600);
        });
      });
    };

    loop();
  };
</script>
<script>
  const evaluerCombat = () => {
    if (!joueurLance || !monstreLance) return;

    const p = parseInt(document.getElementById("player-dice").textContent);
    const m = parseInt(document.getElementById("monster-dice").textContent);

    if (p >= m) {
      monstreActuel.sante -= 20;
      if (monstreActuel.sante <= 0) {
        const lettre = monstreActuel.type;
        lettresConquises[lettre] = (lettresConquises[lettre] || 0) + 1;
        updateConqueredLetters();
        logEvent(`Vous avez vaincu le monstre ${lettre}`);
        monstres = monstres.filter(mon => mon !== monstreActuel);
        player.santeBase += 10;
        player.sante += 10;
        document.getElementById('status').textContent = `Vous avez battu ${lettre} !`;
        cacherDes();
        autoResoudre = false;
      } else {
        logEvent(`Vous avez frapp√© ${monstreActuel.type} (PV restants : ${monstreActuel.sante})`);
        document.getElementById('status').textContent = `Frappez ${monstreActuel.type} (PV : ${monstreActuel.sante})`;
        resetDes();
      }
    } else {
      if (player.armure > 0) player.armure -= 20;
      else player.sante -= 20;
      logEvent(`Le monstre ${monstreActuel.type} vous a frapp√© ! (Votre PV : ${player.sante})`);
      document.getElementById('status').textContent = `Monstre vous a frapp√© ! (PV : ${player.sante})`;
      if (player.sante <= 0) {
        alert("Jeu termin√© !");
        demarrerJeu();
        return;
      }
      resetDes();
    }

    document.getElementById('health').textContent = player.sante;
    document.getElementById('armor').textContent = player.armure;
    document.getElementById('player-combat-health').textContent = player.sante;
    document.getElementById('monster-combat-health').textContent = monstreActuel?.sante || 0;
  };

  const resetDes = () => {
    joueurLance = false;
    monstreLance = false;
    document.getElementById('player-dice').textContent = "0";
    document.getElementById('monster-dice').textContent = "0";
  };

  const afficherDes = () => {
    document.getElementById("dice-game").style.display = "block";
    document.getElementById("monster-type").textContent = monstreActuel.type;
    document.getElementById("player-combat-health").textContent = player.sante;
    document.getElementById("monster-combat-health").textContent = monstreActuel.sante;
    resetDes();
  };

  const cacherDes = () => {
    document.getElementById("dice-game").style.display = "none";
    monstreActuel = null;
  };

  const renderGrille = () => {
    gameGrid.innerHTML = '';
    for (let y = 0; y < gameSize; y++) {
      for (let x = 0; x < gameSize; x++) {
        const cell = document.createElement("div");
        cell.className = "cell";

        if (x === player.x && y === player.y) {
          cell.classList.add("player");
          cell.textContent = "J";
          cell.onclick = () => speak(etiquettes["J"]);
        } else if (monstres.some(m => m.x === x && m.y === y)) {
          const m = monstres.find(m => m.x === x && m.y === y);
          cell.classList.add("monster");
          cell.textContent = m.type;
          const hp = m.sante;
          const atk = 10 + frenchAlphabet.indexOf(m.type);
          cell.onclick = () => speak(`${motsParLettre[m.type] || m.type}. PV ${hp}. Attaque ${atk}.`);
        } else if (tresors.some(t => t.x === x && t.y === y)) {
          cell.classList.add("treasure");
          cell.textContent = "T";
          cell.onclick = () => speak(etiquettes["T"]);
        } else if (potions.some(p => p.x === x && p.y === y)) {
          cell.classList.add("potion");
          cell.textContent = "P";
          cell.onclick = () => speak(etiquettes["P"]);
        } else if (x === escaliers.x && y === escaliers.y) {
          cell.classList.add("stairs");
          cell.textContent = "E";
          cell.onclick = () => speak(etiquettes["E"]);
        } else if (murs.some(w => w.x === x && w.y === y)) {
          cell.classList.add("wall");
        }

        gameGrid.appendChild(cell);
      }
    }
  };

  const positionAleatoire = (exclus = []) => {
    let pos;
    do {
      pos = { x: Math.floor(Math.random() * gameSize), y: Math.floor(Math.random() * gameSize) };
    } while (exclus.some(e => e.x === pos.x && e.y === pos.y));
    return pos;
  };

  const estAccessible = (depart, objectifs, murs) => {
    const file = [depart];
    const visite = new Set();
    const cle = (p) => `${p.x},${p.y}`;
    visite.add(cle(depart));

    while (file.length > 0) {
      const { x, y } = file.shift();
      const voisins = [
        { x: x + 1, y }, { x: x - 1, y },
        { x, y: y + 1 }, { x, y: y - 1 }
      ].filter(p => p.x >= 0 && p.y >= 0 && p.x < gameSize && p.y < gameSize && !murs.some(w => w.x === p.x && w.y === p.y));

      for (const n of voisins) {
        const k = cle(n);
        if (visite.has(k)) continue;
        visite.add(k);
        file.push(n);
        if (objectifs.some(t => t.x === n.x && t.y === n.y)) return true;
      }
    }

    return false;
  };

  const genererNiveauValide = () => {
    while (true) {
      const utilises = [{ x: 0, y: 0 }];
      let murs = Array.from({ length: 15 }, () => positionAleatoire(utilises));
      utilises.push(...murs);

      let monstres = Array.from({ length: 3 }, () => {
        const pos = positionAleatoire(utilises);
        utilises.push(pos);
        const type = frenchAlphabet[Math.floor(Math.random() * (niveauActuel + 1))];
        return { ...pos, sante: 30 + 10 * frenchAlphabet.indexOf(type), type };
      });

      let tresors = Array.from({ length: 3 }, () => {
        const pos = positionAleatoire(utilises);
        utilises.push(pos);
        return pos;
      });

      let potions = Array.from({ length: 2 }, () => {
        const pos = positionAleatoire(utilises);
        utilises.push(pos);
        return pos;
      });

      let escaliers = positionAleatoire(utilises);
      utilises.push(escaliers);

      const accessible = estAccessible(
        { x: 0, y: 0 },
        [...monstres, ...tresors, ...potions, escaliers],
        murs
      );

      if (accessible) {
        return { murs, monstres, tresors, potions, escaliers };
      }
    }
  };

  const declencherTresor = () => {
    const resultat = Math.floor(Math.random() * 4);
    switch (resultat) {
      case 0: player.pieces += 10; logEvent("Vous avez trouv√© 10 pi√®ces !"); break;
      case 1: player.armure += 20; logEvent("Vous avez trouv√© une armure !"); break;
      case 2: player.sante = Math.min(player.santeBase, player.sante + 20); logEvent("Potion bue, sant√© restaur√©e !"); break;
      case 3:
        const type = frenchAlphabet[Math.floor(Math.random() * (niveauActuel + 1))];
        monstreActuel = { x: player.x, y: player.y, sante: 30 + 10 * frenchAlphabet.indexOf(type), type };
        monstres.push(monstreActuel);
        speak(motsParLettre[type] || type);
        logEvent(`Le tr√©sor √©tait un monstre ${type} !`);
        afficherDes();
        return;
    }
    document.getElementById("coins").textContent = player.pieces;
    document.getElementById("armor").textContent = player.armure;
    document.getElementById("health").textContent = player.sante;
  };

  const interagirAvec = (x, y) => {
    if (murs.some(w => w.x === x && w.y === y)) return;

    if (monstres.some(m => m.x === x && m.y === y)) {
      monstreActuel = monstres.find(m => m.x === x && m.y === y);
      speak(motsParLettre[monstreActuel.type] || monstreActuel.type);
      logEvent(`Monstre rencontr√© : ${monstreActuel.type}`);
      afficherDes();
    } else if (tresors.some(t => t.x === x && t.y === y)) {
      speak(etiquettes["T"]);
      declencherTresor();
      tresors = tresors.filter(t => !(t.x === x && t.y === y));
    } else if (potions.some(p => p.x === x && p.y === y)) {
      speak(etiquettes["P"]);
      player.sante = Math.min(player.santeBase, player.sante + 20);
      potions = potions.filter(p => !(p.x === x && p.y === y));
      logEvent("Vous avez bu une potion !");
      document.getElementById("health").textContent = player.sante;
    } else if (x === escaliers.x && y === escaliers.y) {
      speak(etiquettes["E"]);
      niveauActuel = Math.min(frenchAlphabet.length - 1, niveauActuel + 1);
      document.getElementById("level").textContent = frenchAlphabet[niveauActuel];
      logEvent("Vous √™tes descendu au niveau " + frenchAlphabet[niveauActuel]);
      demarrerNiveau();
    }
  };

  const deplacerJoueur = (dx, dy) => {
    if (document.getElementById("dice-game").style.display === "block") return;
    const nx = player.x + dx, ny = player.y + dy;
    if (nx < 0 || ny < 0 || nx >= gameSize || ny >= gameSize) return;
    if (murs.some(w => w.x === nx && w.y === ny)) return;
    player.x = nx;
    player.y = ny;
    interagirAvec(nx, ny);
    renderGrille();
  };

  const demarrerNiveau = () => {
    player.x = 0;
    player.y = 0;
    const { murs: w, monstres: m, tresors: t, potions: p, escaliers: s } = genererNiveauValide();
    murs = w;
    monstres = m;
    tresors = t;
    potions = p;
    escaliers = s;
    cacherDes();
    renderGrille();
  };

  const demarrerJeu = () => {
    player = { x: 0, y: 0, sante: 100, armure: 0, pieces: 0, santeBase: 100 };
    niveauActuel = 0;
    lettresConquises = {};
    updateConqueredLetters();
    document.getElementById("level").textContent = frenchAlphabet[niveauActuel];
    document.getElementById("log-entries").innerHTML = '';
    demarrerNiveau();
  };

  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowUp") deplacerJoueur(0, -1);
    else if (e.key === "ArrowDown") deplacerJoueur(0, 1);
    else if (e.key === "ArrowLeft") deplacerJoueur(-1, 0);
    else if (e.key === "ArrowRight") deplacerJoueur(1, 0);
  });

  demarrerJeu();
</script>
</body>
</html>
